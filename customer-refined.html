<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>FoodTrack Customer</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .hero { text-align: center; padding: 4rem 1rem; background: linear-gradient(rgba(0,0,0,0.5), rgba(0,0,0,0.5)), url('https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=1200'); background-size: cover; color: white; border-radius: var(--radius-lg); margin-bottom: 2rem; }
        .hero h1 { font-size: 3rem; margin-bottom: 1rem; }
        .cart-sidebar { position: fixed; top:0; right:0; width: 350px; height: 100vh; background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1); padding: 2rem; transform: translateX(100%); transition: 0.3s; z-index: 200; display: flex; flex-direction: column; }
        .cart-sidebar.open { transform: translateX(0); }
        .cart-items { flex: 1; overflow-y: auto; margin: 1rem 0; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><span class="logo-icon">üçï</span> FoodTrack</div>
            <div>
                <button class="btn" onclick="toggleCart()">üõí Cart <span id="cartBadge" class="status-badge status-preparing">0</span></button>
                <button class="btn btn-logout" onclick="logout()">Logout</button>
            </div>
        </div>
    </header>

    <div class="container">
        <div class="hero">
            <h1>Craving Something?</h1>
            <p>Order from the best restaurants in town</p>
        </div>

        <h2 class="section-title">Restaurants</h2>
        <div id="restGrid" class="restaurant-grid"></div>

        <h2 class="section-title" style="margin-top:3rem;">Your Orders</h2>
        <div id="historyGrid" class="order-grid"></div>
    </div>

    <!-- Cart Sidebar -->
    <div id="cartSidebar" class="cart-sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Your Cart</h2>
            <button class="btn btn-logout" onclick="toggleCart()">‚úï</button>
        </div>
        <div id="cartList" class="cart-items">
            <p style="text-align:center; color:#888; margin-top:2rem;">Cart is empty</p>
        </div>
        <div style="border-top: 1px solid #eee; padding-top: 1rem;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem; margin-bottom:1rem;">
                <span>Total:</span>
                <span id="cartTotal">$0.00</span>
            </div>
            <button class="btn btn-primary" style="width:100%;" onclick="checkout()">Checkout</button>
        </div>
    </div>

    <!-- Menu Modal -->
    <div id="menuModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Menu</h2>
                <button class="btn btn-logout" onclick="closeMenu()">Close</button>
            </div>
            <div id="dishGrid" class="menu-grid"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script src="utils.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000';
        const token = sessionStorage.getItem('authToken');
        if(!token) window.location.href = 'index.html';

        let cart = { restId: null, items: [] };

        function logout() { sessionStorage.clear(); window.location.href='index.html'; }
        function toggleCart() { document.getElementById('cartSidebar').classList.toggle('open'); }
        function closeMenu() { document.getElementById('menuModal').classList.remove('active'); }

        async function init() {
            // Load Restaurants
            const res = await fetch(API_BASE+'/api/users?role=restaurant', {headers:{'Authorization':'Bearer '+token}});
            const rests = await res.json();
            document.getElementById('restGrid').innerHTML = rests.map(r => `
                <div class="card" onclick="openMenu(${r.id}, '${escapeHtml(r.name)}')">
                    <div style="font-size:3rem; text-align:center; margin-bottom:1rem;">üç±</div>
                    <h3>${escapeHtml(r.name)}</h3>
                    <p style="color:var(--color-text-secondary);">üìç ${escapeHtml(r.location||'Nearby')}</p>
                </div>
            `).join('');
            loadHistory();
        }

        async function openMenu(id, name) {
            document.getElementById('modalTitle').textContent = name;
            const res = await fetch(`${API_BASE}/api/dishes?restaurant_id=${id}`, {headers:{'Authorization':'Bearer '+token}});
            const dishes = await res.json();
            document.getElementById('dishGrid').innerHTML = dishes.map(d => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <h4>${escapeHtml(d.name)}</h4>
                        <p>$${d.price}</p>
                    </div>
                    <button class="btn btn-primary" onclick="addToCart(${id}, ${d.id}, '${escapeHtml(d.name)}', ${d.price})">Add</button>
                </div>
            `).join('');
            document.getElementById('menuModal').classList.add('active');
        }

        function addToCart(restId, dishId, name, price) {
            if(cart.restId && cart.restId !== restId) {
                if(!confirm("Switching restaurants will clear your cart. Continue?")) return;
                cart = { restId: null, items: [] };
            }
            cart.restId = restId;
            const exist = cart.items.find(i => i.dishId === dishId);
            if(exist) exist.quantity++;
            else cart.items.push({ dishId, dishName: name, price, quantity: 1 });
            updateCart();
            toast('Added to cart');
        }

        function updateCart() {
            const list = document.getElementById('cartList');
            if(cart.items.length === 0) list.innerHTML = '<p style="text-align:center; color:#888;">Empty</p>';
            else {
                list.innerHTML = cart.items.map(i => `
                    <div style="display:flex; justify-content:space-between; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid #eee;">
                        <div>${i.quantity}x ${i.dishName}</div>
                        <div>$${(i.price*i.quantity).toFixed(2)}</div>
                    </div>
                `).join('');
            }
            const total = cart.items.reduce((s, i) => s + (i.price*i.quantity), 0);
            document.getElementById('cartTotal').textContent = '$'+total.toFixed(2);
            document.getElementById('cartBadge').textContent = cart.items.reduce((s,i)=>s+i.quantity,0);
        }

        async function checkout() {
            if(cart.items.length === 0) return;
            try {
                const res = await fetch(API_BASE+'/api/orders', {
                    method:'POST',
                    headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+token},
                    body: JSON.stringify({ restaurant_id: cart.restId, items: cart.items })
                });
                if(!res.ok) throw new Error();
                cart = { restId: null, items: [] };
                updateCart();
                toggleCart();
                closeMenu();
                toast('‚úÖ Order Placed!');
                loadHistory();
            } catch(e) { toast('Error placing order'); }
        }

        async function loadHistory() {
            const res = await fetch(API_BASE+'/api/orders', {headers:{'Authorization':'Bearer '+token}});
            const orders = await res.json();
            document.getElementById('historyGrid').innerHTML = orders.reverse().map(o => `
                <div class="card">
                    <div style="display:flex; justify-content:space-between;">
                        <strong>${escapeHtml(o.restaurant_name)}</strong>
                        <span class="status-badge status-${o.status}">${o.status}</span>
                    </div>
                    <div style="margin:1rem 0; font-size:0.9rem; color:#666;">
                        ${o.items.map(i=>`<div>${i.quantity}x ${i.dishName}</div>`).join('')}
                    </div>
                    <div style="text-align:right; font-weight:bold;">$${o.total_price.toFixed(2)}</div>
                </div>
            `).join('');
        }

        init();
    </script>
</body>
</html>
