<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Rider Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><span class="logo-icon">üö¥</span> Rider Portal</div>
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="card" style="margin-bottom:2rem; display:flex; align-items:center; justify-content:space-between; background: #e3f2fd;">
            <div>
                <h3>Current Status</h3>
                <p>You are currently online</p>
            </div>
            <div style="font-size: 2rem;">üü¢</div>
        </div>

        <h2 class="section-title">üî• Active Delivery</h2>
        <div id="activeContainer" style="margin-bottom: 3rem;"></div>

        <h2 class="section-title">üì¶ Available Jobs</h2>
        <div id="availableGrid" class="order-grid"></div>
    </div>
    <div id="toast" class="toast"></div>

    <script src="utils.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000';
        const token = sessionStorage.getItem('authToken');
        if(!token) window.location.href = 'index.html';
        let myId = null;

        async function init() {
            const me = await fetch(API_BASE+'/api/me', {headers:{'Authorization':'Bearer '+token}}).then(r=>r.json());
            myId = me.user.id;
            refresh();
            setInterval(refresh, 5000);
        }

        async function refresh() {
            const res = await fetch(API_BASE+'/api/orders', {headers:{'Authorization':'Bearer '+token}});
            const orders = await res.json();

            // Active
            const active = orders.find(o => o.rider_id === myId && o.status === 'delivering');
            const activeDiv = document.getElementById('activeContainer');
            
            if(active) {
                activeDiv.innerHTML = `
                <div class="card" style="border: 2px solid var(--color-primary); background: #fff8f0;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                        <h2>Current Job #${active.id}</h2>
                        <span class="status-badge status-delivering">In Progress</span>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:2rem;">
                        <div>
                            <h4>üè™ Pickup From:</h4>
                            <p>${escapeHtml(active.restaurant_name)}</p>
                        </div>
                        <div>
                            <h4>üìç Deliver To:</h4>
                            <p>${escapeHtml(active.customer_name)}</p>
                            <p>${escapeHtml(active.delivery_address || 'Main St')}</p>
                        </div>
                    </div>
                    <button class="btn btn-success" style="width:100%; margin-top:1rem; padding:1rem;" onclick="finish(${active.id})">‚úÖ Mark Delivered</button>
                </div>`;
            } else {
                activeDiv.innerHTML = `<p style="color:#888;">No active deliveries. Pick one below!</p>`;
            }

            // Available
            const avail = orders.filter(o => o.status === 'ready' && !o.rider_id);
            document.getElementById('availableGrid').innerHTML = avail.map(o => `
                <div class="card">
                    <div style="margin-bottom:1rem;">
                        <span class="status-badge status-ready">Ready for Pickup</span>
                    </div>
                    <h4>${escapeHtml(o.restaurant_name)}</h4>
                    <p>To: ${escapeHtml(o.customer_name)}</p>
                    <p style="color:var(--color-success); font-weight:bold; margin: 0.5rem 0;">Earn: $${(o.delivery_fee||5).toFixed(2)}</p>
                    <button class="btn btn-primary" style="width:100%;" onclick="accept(${o.id})">Accept Job</button>
                </div>
            `).join('') || '<p>No new jobs found.</p>';
        }

        async function accept(id) {
            await fetch(`${API_BASE}/api/orders/${id}`, {
                method: 'PATCH',
                headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+token},
                body: JSON.stringify({rider_id: myId, status:'delivering'})
            });
            refresh();
            toast('Job Accepted!');
        }

        async function finish(id) {
            await fetch(`${API_BASE}/api/orders/${id}`, {
                method: 'PATCH',
                headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+token},
                body: JSON.stringify({status:'delivered'})
            });
            refresh();
            toast('Job Completed! üí∞');
        }

        function logout(){ sessionStorage.clear(); window.location.href='index.html'; }
        init();
    </script>
</body>
</html>
