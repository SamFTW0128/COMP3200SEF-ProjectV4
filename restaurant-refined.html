<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Restaurant Dashboard</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo"><span class="logo-icon">üè™</span> <span id="restName">My Restaurant</span></div>
            <button class="btn btn-logout" onclick="logout()">Logout</button>
        </div>
    </header>

    <div class="container">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon">üì¶</div>
                <div class="stat-value" id="totalOrders">0</div>
                <div>Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon">üí∞</div>
                <div class="stat-value" id="totalRev">$0</div>
                <div>Revenue</div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('orders')">Live Orders</button>
            <button class="tab" onclick="switchTab('menu')">Menu Management</button>
        </div>

        <!-- Orders Tab -->
        <div id="ordersTab" class="tab-content active">
            <div id="ordersGrid" class="order-grid"></div>
        </div>

        <!-- Menu Tab -->
        <div id="menuTab" class="tab-content">
            <div style="margin-bottom: 2rem; background: white; padding: 1.5rem; border-radius: var(--radius-md);">
                <h3>Add New Dish</h3>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <input id="dishName" class="form-input" placeholder="Dish Name">
                    <input id="dishPrice" type="number" class="form-input" placeholder="Price ($)" style="width: 100px;">
                    <button class="btn btn-primary" onclick="addDish()">+ Add</button>
                </div>
            </div>
            <div id="menuGrid" class="menu-grid"></div>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script src="utils.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000';
        const token = sessionStorage.getItem('authToken');
        if(!token) window.location.href = 'index.html';

        function logout() { sessionStorage.clear(); window.location.href='index.html'; }
        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(e=>e.classList.remove('active'));
            document.getElementById(t+'Tab').classList.add('active');
            event.target.classList.add('active');
            if(t==='orders') loadOrders();
            if(t==='menu') loadMenu();
        }

        async function loadOrders() {
            try {
                const me = await fetch(API_BASE+'/api/me', {headers:{'Authorization':'Bearer '+token}}).then(r=>r.json());
                document.getElementById('restName').textContent = me.user.name;

                const res = await fetch(API_BASE+'/api/orders', {headers:{'Authorization':'Bearer '+token}});
                const orders = await res.json();
                
                // Stats
                document.getElementById('totalOrders').textContent = orders.length;
                const rev = orders.filter(o=>o.status==='delivered').reduce((sum,o)=>sum+o.total_price,0);
                document.getElementById('totalRev').textContent = '$'+rev.toFixed(2);

                const grid = document.getElementById('ordersGrid');
                grid.innerHTML = orders.map(o => {
                    const itemsHtml = o.items.map(i => `
                        <div style="display:flex; justify-content:space-between; font-size:0.9rem; padding:4px 0; border-bottom:1px dashed #eee;">
                            <span>${i.quantity}x ${escapeHtml(i.dishName)}</span>
                        </div>`).join('');

                    return `
                    <div class="card" style="border-left: 5px solid var(--color-primary);">
                        <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
                            <span class="status-badge status-${o.status}">${o.status}</span>
                            <span style="font-weight:bold;">#${o.id}</span>
                        </div>
                        <div style="margin-bottom:1rem;">
                            <strong>üë§ ${escapeHtml(o.customer_name)}</strong>
                        </div>
                        <div style="background:var(--color-bg); padding:0.5rem; border-radius:5px; margin-bottom:1rem;">
                            ${itemsHtml}
                        </div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <strong style="font-size:1.2rem;">$${o.total_price.toFixed(2)}</strong>
                            ${getActionButtons(o)}
                        </div>
                    </div>`;
                }).join('') || '<p>No orders yet</p>';
            } catch(e) { console.error(e); }
        }

        function getActionButtons(o) {
            if(o.status === 'pending') return `
                <div style="display:flex; gap:0.5rem;">
                    <button class="btn btn-success" onclick="setStatus(${o.id}, 'preparing')">Accept</button>
                    <button class="btn btn-danger" onclick="setStatus(${o.id}, 'cancelled')">Reject</button>
                </div>`;
            if(o.status === 'preparing') return `<button class="btn btn-primary" onclick="setStatus(${o.id}, 'ready')">Mark Ready</button>`;
            if(o.status === 'ready') return `<span style="color:var(--color-text-secondary);">Waiting for Rider...</span>`;
            return '';
        }

        async function setStatus(id, status) {
            await fetch(`${API_BASE}/api/orders/${id}`, {
                method: 'PATCH',
                headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+token},
                body: JSON.stringify({status})
            });
            loadOrders();
        }

        async function loadMenu() {
            const me = await fetch(API_BASE+'/api/me', {headers:{'Authorization':'Bearer '+token}}).then(r=>r.json());
            const res = await fetch(`${API_BASE}/api/dishes?restaurant_id=${me.user.id}`, {headers:{'Authorization':'Bearer '+token}});
            const dishes = await res.json();
            document.getElementById('menuGrid').innerHTML = dishes.map(d => `
                <div class="card">
                    <h3>${escapeHtml(d.name)}</h3>
                    <p style="color:var(--color-text-secondary);">$${d.price.toFixed(2)}</p>
                    <button class="btn btn-danger" style="margin-top:1rem;" onclick="deleteDish(${d.id})">Delete</button>
                </div>
            `).join('');
        }

        async function addDish() {
            const name = document.getElementById('dishName').value;
            const price = document.getElementById('dishPrice').value;
            if(!name || !price) return;
            await fetch(API_BASE+'/api/dishes', {
                method:'POST',
                headers: {'Content-Type':'application/json', 'Authorization':'Bearer '+token},
                body: JSON.stringify({name, price: parseFloat(price), category:'Main'})
            });
            document.getElementById('dishName').value = '';
            loadMenu();
        }

        async function deleteDish(id) {
            await fetch(`${API_BASE}/api/dishes/${id}`, { method:'DELETE', headers:{'Authorization':'Bearer '+token} });
            loadMenu();
        }

        loadOrders();
        setInterval(loadOrders, 5000);
    </script>
</body>
</html>
