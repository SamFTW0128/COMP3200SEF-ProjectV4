<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodTrack - Welcome</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        body { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #ffe8d6 0%, #ffb380 100%); }
        .auth-container { max-width: 450px; width: 100%; padding: 2rem; }
        .logo-large { font-size: 4rem; text-align: center; margin-bottom: 1rem; display: block; }
        .role-selector { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 1.5rem; }
        .role-btn { padding: 0.75rem; background: rgba(255,255,255,0.5); border: 2px solid transparent; border-radius: var(--radius-md); font-weight: 600; }
        .role-btn.active { background: white; border-color: var(--color-primary); color: var(--color-primary); box-shadow: var(--shadow-sm); }
        .auth-card { background: white; padding: 2rem; border-radius: var(--radius-lg); box-shadow: var(--shadow-md); }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo-large">üçî</div>
        <h1 style="text-align: center; margin-bottom: 2rem; color: #2d1810;">FoodTrack</h1>
        
        <div class="auth-card">
            <div class="role-selector">
                <button class="role-btn active" onclick="setRole('customer')">üçï Customer</button>
                <button class="role-btn" onclick="setRole('restaurant')">üè™ Restaurant</button>
                <button class="role-btn" onclick="setRole('rider')">üö¥ Rider</button>
                <button class="role-btn" onclick="setRole('admin')">‚öôÔ∏è Admin</button>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="setMode('login')">Login</button>
                <button class="tab" onclick="setMode('register')">Register</button>
            </div>

            <form id="authForm" onsubmit="handleAuth(event)">
                <div class="form-group">
                    <label class="form-label">User ID</label>
                    <input type="text" id="userId" class="form-input" placeholder="e.g. cust01" required>
                </div>
                
                <div id="extraFields" style="display: none;">
                    <div class="form-group">
                        <label class="form-label">Full Name</label>
                        <input type="text" id="userName" class="form-input">
                    </div>
                    <div class="form-group" id="locField" style="display:none;">
                        <label class="form-label">Location</label>
                        <input type="text" id="userLoc" class="form-input" placeholder="e.g. Downtown">
                    </div>
                    <div class="form-group" id="vehField" style="display:none;">
                        <label class="form-label">Vehicle</label>
                        <select id="userVeh" class="form-select">
                            <option value="Bike">Bike</option>
                            <option value="Scooter">Scooter</option>
                            <option value="Car">Car</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-input" required>
                </div>

                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 1rem;">Go ‚ûî</button>
            </form>
        </div>
    </div>
    <div id="toast" class="toast"></div>

    <script src="utils.js"></script>
    <script>
        const API_BASE = 'http://localhost:3000'; // Change to Render URL for online
        let currRole = 'customer';
        let currMode = 'login';

        function setRole(role) {
            currRole = role;
            document.querySelectorAll('.role-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            updateFields();
        }

        function setMode(mode) {
            currMode = mode;
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            updateFields();
        }

        function updateFields() {
            const extra = document.getElementById('extraFields');
            extra.style.display = currMode === 'register' ? 'block' : 'none';
            document.getElementById('locField').style.display = (currMode === 'register' && currRole === 'restaurant') ? 'block' : 'none';
            document.getElementById('vehField').style.display = (currMode === 'register' && currRole === 'rider') ? 'block' : 'none';
        }

        async function handleAuth(e) {
            e.preventDefault();
            const id = document.getElementById('userId').value;
            const pass = document.getElementById('password').value;
            const endpoint = currMode === 'login' ? '/api/login' : '/api/register';

            const payload = { id, password: pass, role: currRole };
            if (currMode === 'register') {
                payload.name = document.getElementById('userName').value;
                if(currRole === 'restaurant') payload.location = document.getElementById('userLoc').value;
                if(currRole === 'rider') payload.deliveryMethod = document.getElementById('userVeh').value;
            }

            try {
                const res = await fetch(API_BASE + endpoint, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if(!res.ok) throw new Error(data.error);

                // IMPORTANT: Using sessionStorage
                sessionStorage.setItem('authToken', data.token);
                window.location.href = `${currRole}-refined.html`;
            } catch(err) {
                toast("‚ùå " + err.message);
            }
        }
    </script>
</body>
</html>
